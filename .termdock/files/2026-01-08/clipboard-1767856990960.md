Minimum Count Protection - å·¥ä½œäº¤æ¥æ–‡ä»¶

  âœ… å·²å®Œæˆå·¥ä½œï¼ˆPhase 1-2ï¼‰

  Phase 1: Data Layer Protectionï¼ˆå·²å®Œæˆï¼‰

  æª”æ¡ˆä¿®æ”¹ï¼š

  1. src/app/sidebar/organizations.tsx (lines 118-183)
    - âœ… æ–°å¢æœ€å°æ•¸é‡æª¢æŸ¥ï¼šorganizations.length <= 1 æ™‚ throw error
    - âœ… æ”¹ç‚ºç´šè¯åˆªé™¤ï¼ˆç§»é™¤ reassignment é‚è¼¯ï¼‰
    - âœ… ç´šè¯åˆªé™¤æ‰€æœ‰ Categories â†’ Groups â†’ Webpages
  2. src/app/sidebar/categories.tsx (lines 281-320)
    - âœ… æ–°å¢ per-organization æœ€å°æ•¸é‡æª¢æŸ¥
    - âœ… ç¢ºèªç´šè¯åˆªé™¤å®Œæ•´ï¼ˆwebpages + groupsï¼‰
    - âœ… éŒ¯èª¤è™•ç†å®Œæ•´
  3. src/app/groups/GroupsView.tsx (lines 137-171)
    - âœ… å·²æœ‰æœ€å°æ•¸é‡ä¿è­·
    - âœ… ä½¿ç”¨ deleteSubcategoryAndPages ç´šè¯åˆªé™¤

  Phase 2: UI Layer Protectionï¼ˆå·²å®Œæˆï¼‰

  æª”æ¡ˆä¿®æ”¹ï¼š

  1. src/app/sidebar/OrganizationNav.tsx (lines 98-173)
    - âœ… æ–°å¢å³éµ context menu
    - âœ… æ–°å¢åˆªé™¤ç¢ºèªå°è©±æ¡†ï¼ˆå‰›å‰›æ”¹é€²éï¼‰
    - âœ… UI å±¤æœ€å°æ•¸é‡æª¢æŸ¥
    - âœ… éŒ¯èª¤è™•ç†ï¼ˆconsole.error + toastï¼‰
  2. src/app/sidebar/sidebar.tsx (lines 234-253)
    - âœ… Collection åˆªé™¤ UI å±¤æª¢æŸ¥
    - âœ… Toast è¨Šæ¯çµ±ä¸€
    - âœ… å®Œæ•´éŒ¯èª¤è™•ç†
  3. src/app/groups/GroupsView.tsx (lines 144, 168)
    - âœ… Toast è¨Šæ¯æ ¼å¼çµ±ä¸€
    - âœ… console.error å·²åŠ å…¥

  ---
  âš ï¸ Phase 3: æ¸¬è©¦å•é¡Œï¼ˆéœ€è¦ä¿®æ­£ï¼‰

  å·²å»ºç«‹çš„æ¸¬è©¦æª”æ¡ˆ

  1. src/app/sidebar/__tests__/organizations.delete.test.tsx
    - ç‹€æ…‹ï¼š3/4 æ¸¬è©¦é€šé
    - å•é¡Œï¼šéŒ¯èª¤è™•ç†æ¸¬è©¦ç­–ç•¥éœ€èª¿æ•´ï¼ˆæ¸¬è©¦ç‹€æ…‹ä¸è®Šè€Œéæ•ç²éŒ¯èª¤ï¼‰
  2. src/app/sidebar/__tests__/categories.delete.test.tsx
    - ç‹€æ…‹ï¼š1/6 æ¸¬è©¦é€šé
    - å•é¡Œï¼š
        - ç•°æ­¥è¼‰å…¥éœ€è¦æ›´é•·ç­‰å¾…æ™‚é–“
      - Categories Provider éœ€è¦ç­‰å¾… IndexedDB è³‡æ–™è¼‰å…¥
  3. src/app/groups/__tests__/GroupsView.delete.test.tsx
    - ç‹€æ…‹ï¼š0/4 æ¸¬è©¦å¤±æ•—
    - å•é¡Œï¼š
        - åˆªé™¤æŒ‰éˆ•åœ¨ context menu ä¸­ï¼Œéœ€è¦å…ˆé»ã€Œæ›´å¤šæ“ä½œã€(â‹¯)
      - æ¸¬è©¦æ‰¾ä¸åˆ° aria-label="åˆªé™¤" çš„æŒ‰éˆ•
      - éœ€è¦èª¿æ•´æ¸¬è©¦æµç¨‹ï¼šé»æ“Šã€Œæ›´å¤šæ“ä½œã€â†’ é»æ“Š menu ä¸­çš„ã€Œåˆªé™¤ã€â†’ é»æ“Šç¢ºèªå°è©±æ¡†
  4. src/app/__tests__/delete-protection.integration.test.tsx
    - ç‹€æ…‹ï¼š0/5 æ¸¬è©¦å¤±æ•—
    - å•é¡Œï¼š
        - æ¸¬è©¦ä¸­ä½¿ç”¨ require() å‹•æ…‹è¼‰å…¥æ¨¡çµ„å°è‡´éŒ¯èª¤
      - éœ€è¦æ”¹ç‚ºéœæ…‹ import
      - Provider çµæ§‹éœ€è¦æ­£ç¢ºè¨­ç½®

  æ¸¬è©¦ä¿®æ­£å»ºè­°

  // GroupsView.delete.test.tsx éœ€è¦çš„ä¿®æ­£
  // 1. æ‰“é–‹ context menu
  const moreButton = screen.getByLabelText('æ›´å¤šæ“ä½œ');
  fireEvent.click(moreButton);

  // 2. é»æ“Šåˆªé™¤é¸é …
  const deleteOption = await screen.findByText('åˆªé™¤');
  fireEvent.click(deleteOption);

  // 3. ç¢ºèªå°è©±æ¡†å‡ºç¾
  const confirmButton = await screen.findByText('ç¢ºèªåˆªé™¤');
  fireEvent.click(confirmButton);

  // integration test éœ€è¦æ”¹ç‚ºéœæ…‹ import
  import { useOrganizations } from '../sidebar/organizations';
  import { useCategories } from '../sidebar/categories';

  // è€Œä¸æ˜¯ï¼š
  const { useOrganizations } = require('../sidebar/organizations');

  ---
  ğŸ†• æ–°éœ€æ±‚ï¼šç®¡ç† Organizations æŒ‰éˆ•

  éœ€æ±‚æè¿°ï¼š
  ç”¨æˆ¶åé¥‹å³éµé»æ“Šä¸å¤ ç›´è§€ï¼Œè¦æ±‚æ–°å¢ã€Œç®¡ç† Organizationsã€æŒ‰éˆ•ã€‚

  å»ºè­°å¯¦ä½œä½ç½®ï¼š
  src/app/sidebar/OrganizationNav.tsx

  å»ºè­°å¯¦ä½œæ–¹å¼ï¼š
  // 1. åœ¨ organizations list ä¸Šæ–¹æˆ–ä¸‹æ–¹æ–°å¢æŒ‰éˆ•
  <button
    className="w-12 h-12 rounded-full border-2 border-slate-600..."
    onClick={() => setManageDialogOpen(true)}
    title="ç®¡ç† Organizations"
  >
    <svg>...ç·¨è¼¯åœ–æ¨™...</svg>
  </button>

  // 2. æ–°å¢å°è©±æ¡†é¡¯ç¤ºæ‰€æœ‰ organizations
  {manageDialogOpen && (
    <div className="fixed inset-0 z-[9999] bg-black/60...">
      <div className="å°è©±æ¡†æ¨£å¼">
        <h3>ç®¡ç† Organizations</h3>
        {organizations.map(org => (
          <div key={org.id} className="flex items-center gap-2">
            <div style={{backgroundColor: org.color}}>
              {org.name}
            </div>
            <button onClick={() => handleRename(org.id)}>é‡æ–°å‘½å</button>
            <button 
              className="text-red-400"
              onClick={() => setConfirmDeleteOrg(org.id)}
            >
              åˆªé™¤
            </button>
          </div>
        ))}
      </div>
    </div>
  )}

  åƒè€ƒç¾æœ‰ UI é¢¨æ ¼ï¼š
  - å°è©±æ¡†æ¨£å¼åƒè€ƒï¼šsrc/app/groups/GroupsView.tsx lines 384-434 çš„ç¢ºèªå°è©±æ¡†
  - åˆ—è¡¨æ¨£å¼åƒè€ƒï¼šsrc/app/sidebar/sidebar.tsx çš„ categories åˆ—è¡¨

  ---
  ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œæ¸…å–®

  å„ªå…ˆç´š 1ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰

  1. æ–°å¢ã€Œç®¡ç† Organizationsã€æŒ‰éˆ•å’Œå°è©±æ¡†
    - ä½ç½®ï¼šsrc/app/sidebar/OrganizationNav.tsx
    - åŠŸèƒ½ï¼šåˆ—è¡¨é¡¯ç¤ºã€é‡æ–°å‘½åã€åˆªé™¤ï¼ˆæ›´ç›´è§€çš„ UIï¼‰

  å„ªå…ˆç´š 2ï¼ˆæ¸¬è©¦ä¿®æ­£ï¼‰

  2. ä¿®æ­£ GroupsView åˆªé™¤æ¸¬è©¦
    - æª”æ¡ˆï¼šsrc/app/groups/__tests__/GroupsView.delete.test.tsx
    - èª¿æ•´ UI äº’å‹•æµç¨‹ï¼ˆcontext menuï¼‰
  3. ä¿®æ­£ Categories åˆªé™¤æ¸¬è©¦
    - æª”æ¡ˆï¼šsrc/app/sidebar/__tests__/categories.delete.test.tsx
    - å¢åŠ ç•°æ­¥ç­‰å¾…æ™‚é–“
  4. ä¿®æ­£æ•´åˆæ¸¬è©¦
    - æª”æ¡ˆï¼šsrc/app/__tests__/delete-protection.integration.test.tsx
    - æ”¹ç‚ºéœæ…‹ import
  5. ä¿®æ­£ Organizations åˆªé™¤æ¸¬è©¦
    - æª”æ¡ˆï¼šsrc/app/sidebar/__tests__/organizations.delete.test.tsx
    - èª¿æ•´éŒ¯èª¤è™•ç†æ¸¬è©¦ç­–ç•¥

  å„ªå…ˆç´š 3ï¼ˆæ–‡æª”æ›´æ–°ï¼‰

  6. æ›´æ–°æ–‡æª”
    - docs/architecture/component-map.md
    - docs/specs/data-format.md
    - docs/meta/SESSION_HANDOFF.md

  ---
  ğŸ“‚ é‡è¦æª”æ¡ˆä½ç½®

  src/app/sidebar/
  â”œâ”€â”€ OrganizationNav.tsx        # Organization UI (å«åˆªé™¤åŠŸèƒ½)
  â”œâ”€â”€ organizations.tsx          # Organization Provider (lines 118-183 åˆªé™¤é‚è¼¯)
  â”œâ”€â”€ categories.tsx             # Categories Provider (lines 281-320 åˆªé™¤é‚è¼¯)
  â””â”€â”€ sidebar.tsx                # Collection UI (lines 234-253)

  src/app/groups/
  â””â”€â”€ GroupsView.tsx             # Group ç®¡ç† (lines 137-171 åˆªé™¤é‚è¼¯)

  src/background/
  â”œâ”€â”€ storageService.ts          # Storage Service API
  â””â”€â”€ idb/
      â””â”€â”€ storage.ts             # IndexedDB operations

  openspec/changes/minimum-count-protection/
  â”œâ”€â”€ proposal.md                # è®Šæ›´ææ¡ˆ
  â”œâ”€â”€ design.md                  # è¨­è¨ˆæ–‡ä»¶
  â”œâ”€â”€ tasks.md                   # å·¥ä½œæ¸…å–®ï¼ˆå·²æ›´æ–°ç‹€æ…‹ï¼‰
  â””â”€â”€ specs/                     # è¦æ ¼æ›´æ–°

  æ¸¬è©¦æª”æ¡ˆï¼š
  src/app/sidebar/__tests__/
  â”œâ”€â”€ organizations.delete.test.tsx  # âœ… å·²å»ºç«‹ï¼Œ3/4 pass
  â””â”€â”€ categories.delete.test.tsx     # âœ… å·²å»ºç«‹ï¼Œ1/6 pass

  src/app/groups/__tests__/
  â””â”€â”€ GroupsView.delete.test.tsx     # âœ… å·²å»ºç«‹ï¼Œ0/4 pass

  src/app/__tests__/
  â””â”€â”€ delete-protection.integration.test.tsx  # âœ… å·²å»ºç«‹ï¼Œ0/5 pass

  ---
  ğŸ”‘ é—œéµæ¦‚å¿µ

  ä¸‰å±¤ä¿è­·æ©Ÿåˆ¶

  1. Organization: å…¨åŸŸè‡³å°‘ä¿ç•™ 1 å€‹
  2. Collection: æ¯å€‹ Organization è‡³å°‘ä¿ç•™ 1 å€‹
  3. Group: æ¯å€‹ Collection è‡³å°‘ä¿ç•™ 1 å€‹

  é›™é‡ä¿è­·

  - UI å±¤: å³æ™‚æª¢æŸ¥ä¸¦é˜»æ“‹ï¼ˆæä¾› Toast è¨Šæ¯ï¼‰
  - Data å±¤: StorageService ä¸­çš„å®‰å…¨æª¢æŸ¥

  ç´šè¯åˆªé™¤

  - Organization â†’ åˆªé™¤æ‰€æœ‰ Collection â†’ åˆªé™¤æ‰€æœ‰ Group â†’ åˆªé™¤æ‰€æœ‰ Webpages
  - Collection â†’ åˆªé™¤æ‰€æœ‰ Group â†’ åˆªé™¤æ‰€æœ‰ Webpages
  - Group â†’ åˆªé™¤æ‰€æœ‰ Webpages

  ---
  é€™ä»½æ–‡ä»¶æ‡‰è©²åŒ…å«äº†æ‰€æœ‰å¿…è¦è³‡è¨Šã€‚å»ºè­°å…ˆå®Œæˆã€Œç®¡ç† Organizationsã€æŒ‰éˆ•ï¼Œå†è™•ç†æ¸¬è©¦ä¿®æ­£ã€‚
