å ´æ™¯ï¼šå¾ž Group A æ‹–å¡ç‰‡ X åˆ° Group B

  âœ… éšŽæ®µ 1ï¼šdragOverï¼ˆé è¦½éšŽæ®µï¼‰

  // Line 282-284: Group B çš„ CardGrid è™•ç† dragOver
  const gi = computeGhostIndex(e.clientX, e.clientY, e.target);  // gi = 2
  setGhostIndex(gi);

  // âš ï¸ é—œéµï¼šè¨ˆç®— ghostBeforeRef
  const list = hiddenCardId ? items.filter((x)=>x.id!==hiddenCardId) : items;
  //        â†‘ hiddenCardId å¯èƒ½æ˜¯ null æˆ–èˆŠå€¼
  // list = [B1, B2, B3, B4]  (Group B çš„å¡ç‰‡ï¼Œä¸åŒ…å« X)

  ghostBeforeRef.current = gi >= list.length ? '__END__' : list[gi].id;
  // gi=2 â†’ ghostBeforeRef.current = 'B3'  (ç¬¬ 3 å¼µå¡ç‰‡çš„ ID)

  âœ… éšŽæ®µ 2ï¼šæ¸²æŸ“ Ghost

  // Line 440: éŽæ¿¾åˆ—è¡¨
  const viewItems = ghostActive && draggingCardId
    ? items.filter((x) => x.id !== draggingCardId)  // draggingCardId = 'X'
    : items;
  // viewItems = [B1, B2, B3, B4]  (Group B ä¸åŒ…å« Xï¼Œæ‰€ä»¥éŽæ¿¾æ²’å½±éŸ¿)

  // Line 444-446: è¨ˆç®— Ghost æ’å…¥ä½ç½®
  const gBefore = ghostBeforeRef.current;  // = 'B3'
  gIdx = viewItems.findIndex((it) => it.id === gBefore);  // gIdx = 2

  // æ¸²æŸ“çµæžœï¼šGhost é¡¯ç¤ºåœ¨ B2 å’Œ B3 ä¹‹é–“ âœ“ æ­£ç¢º
  // [B1] [B2] [ðŸ‘» Ghost] [B3] [B4]

  âŒ éšŽæ®µ 3ï¼šhandleDropï¼ˆå¯¦éš›æ’å…¥ï¼‰

  // Line 332-347: Fallback 1 - DOM æŸ¥è©¢
  const ghostCard = zone?.querySelector('[data-testid="ghost-card"]');
  const ghostWrap = ghostCard?.closest('.toby-card-flex');
  let next = ghostWrap?.nextElementSibling;

  while (next && (
    !next.getAttribute('data-card-id') ||
    next.getAttribute('data-hidden') === 'true' ||
    next.getAttribute('data-card-id') === fromId  // â† è·³éŽ X è‡ªå·±
  )) {
    next = next.nextElementSibling;
  }

  beforeId = next?.getAttribute('data-card-id') || '__END__';

  ðŸ”´ å•é¡Œé»ž 1ï¼šå¦‚æžœ React æ¸²æŸ“æ»¯å¾Œï¼ŒDOM ä¸­çš„ ghost ä½ç½®å¯èƒ½ä¸æº–ç¢º

  ðŸ”´ å•é¡Œé»ž 2ï¼šwhile å¾ªç’°è·³éŽ fromIdï¼Œä½†åœ¨è·¨ Group æ‹–æ”¾æ™‚ï¼ŒGroup B ä¸­ä¸å­˜åœ¨ Xï¼Œé€™å€‹æ¢ä»¶æ˜¯å¤šé¤˜çš„

  // Line 348: Fallback 2 - ä½¿ç”¨ ghostBeforeRef
  if (!beforeId) beforeId = ghostBeforeRef.current;  // = 'B3' âœ“

  // Line 356: åŸ·è¡Œæ’å…¥
  onDropExistingCard?.('X', 'B3');

  ç†è«–ä¸Šæ‡‰è©²æ­£ç¢ºï¼Œä½†ç¹¼çºŒçœ‹å¾Œç«¯è™•ç†...

  âŒ éšŽæ®µ 4ï¼šGroupsView è™•ç†æ’å…¥

  // GroupsView.tsx Line 384-407
  onDropExistingCard={async (cardId, beforeId) => {
    // cardId='X', beforeId='B3'

    if ((svc as any).moveCardToGroup) {
      await (svc as any).moveCardToGroup(cardId, g.categoryId, g.id, beforeId);
    } else {
      // âš ï¸ é—œéµï¼šä¸‰æ­¥æ“ä½œ
      await actions.updateCategory(cardId, g.categoryId);       // Step 1
      await (svc as any).updateCardSubcategory?.(cardId, g.id); // Step 2

      if (!beforeId || beforeId === '__END__') {
        await (actions as any).moveToEnd(cardId);               // Step 3a
      } else {
        await actions.reorder(cardId, beforeId);                // Step 3b: reorder('X', 'B3')
      }
    }
    await actions.load();
  }

  ---
  ðŸ”´ æ ¹æœ¬åŽŸå› ï¼šStep 1-2 å¯èƒ½ç ´å£ž beforeId çš„æœ‰æ•ˆæ€§

  å•é¡Œ Aï¼šreorder() çš„å‰ç½®æ¢ä»¶è¢«ç ´å£ž

  å‡è¨­ reorder(cardId, beforeId) çš„å¯¦ç¾é‚è¼¯ï¼š
  // å½ä»£ç¢¼
  function reorder(cardId, beforeId) {
    const targetIndex = items.findIndex(it => it.id === beforeId);
    const currentIndex = items.findIndex(it => it.id === cardId);

    // ç§»é™¤ cardId
    items.splice(currentIndex, 1);
    // æ’å…¥åˆ° beforeId ä¹‹å‰
    items.splice(targetIndex, 0, card);
  }

  å•é¡Œï¼š
  1. updateCategory(X, categoryB) åŸ·è¡Œå¾Œï¼ŒX å¯èƒ½è¢«ç§»åˆ° categoryB çš„ã€Œæœ«å°¾ã€ï¼ˆé»˜èªé †åºï¼‰
  2. æ­¤æ™‚ items = [B1, B2, B3, B4, X]
  3. åŸ·è¡Œ reorder(X, B3) æ™‚ï¼š
    - currentIndex = 4 (X åœ¨æœ«å°¾)
    - targetIndex = 2 (B3 çš„ä½ç½®)
    - ç§»é™¤ X â†’ [B1, B2, B3, B4]
    - æ’å…¥åˆ°ä½ç½® 2 â†’ [B1, B2, X, B3, B4] âœ“ çœ‹èµ·ä¾†å°ï¼Ÿ

  å•é¡Œ Bï¼šå¦‚æžœ X åŽŸæœ¬å°±åœ¨ Group Bï¼ˆåŒ group å…§æ‹–æ”¾ï¼‰

  1. åŽŸå§‹é †åºï¼š[B1, X, B2, B3, B4] (X åœ¨ä½ç½® 1)
  2. æƒ³æ‹– X åˆ° B3 å’Œ B4 ä¹‹é–“ï¼ˆä½ç½® 3ï¼‰
  3. Ghost é¡¯ç¤ºï¼š[B1, B2, B3, ðŸ‘», B4] âœ“
  4. beforeId = 'B4' âœ“
  5. ä½† updateCategory å’Œ updateSubcategory å¯èƒ½è§¸ç™¼å…§éƒ¨çš„æŽ’åºé‚è¼¯
  6. åŸ·è¡Œ reorder(X, B4) æ™‚ï¼ŒX çš„ä½ç½®å¯èƒ½å·²ç¶“è®Šäº†

  å•é¡Œ Cï¼šhiddenCardId vs draggingCardId ä¸åŒæ­¥

  // dragOver éšŽæ®µï¼ˆLine 284ï¼‰
  const list = hiddenCardId ? items.filter((x)=>x.id!==hiddenCardId) : items;
  ghostBeforeRef.current = list[gi].id;

  å ´æ™¯ï¼š
  1. é–‹å§‹æ‹–å‹• Xï¼ŒdraggingCardId = 'X'
  2. ä½† lt:ghost-active äº‹ä»¶é‚„æ²’è§¸ç™¼ï¼ŒhiddenCardId = null
  3. è¨ˆç®— ghostBeforeRef æ™‚ï¼š
  const list = items;  // åŒ…å« Xï¼
  // list = [B1, X, B2, B3, B4]
  // gi = 3 (æƒ³æ’å…¥åˆ° B3 å’Œ B4 ä¹‹é–“)
  ghostBeforeRef.current = list[3].id;  // = 'B3' âœ— éŒ¯èª¤ï¼æ‡‰è©²æ˜¯ 'B4'

  ---
  ðŸŽ¯ é—œéµå•é¡Œç¸½çµ
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚            å•é¡Œ            â”‚        ä½ç½®        â”‚               å½±éŸ¿               â”‚ åš´é‡åº¦ â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ A. hiddenCardId æ›´æ–°æ»¯å¾Œ   â”‚ Line 284           â”‚ è¨ˆç®— ghostBeforeRef æ™‚åˆ—è¡¨ä¸ä¸€è‡´ â”‚ ðŸ”´ é«˜  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ B. DOM æŸ¥è©¢ä¾è³´æ¸²æŸ“æ™‚æ©Ÿ    â”‚ Line 332-347       â”‚ Drop æ™‚å¯èƒ½æ‰¾ä¸åˆ° ghost card     â”‚ ðŸŸ¡ ä¸­  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ C. updateCategory æ”¹è®Šé †åº â”‚ GroupsView:389-391 â”‚ beforeId å¯èƒ½å¤±æ•ˆ                â”‚ ðŸ”´ é«˜  â”‚
  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤
  â”‚ D. while å¾ªç’°é‚è¼¯éŒ¯èª¤      â”‚ Line 337-345       â”‚ ç‰¹å®šå ´æ™¯ä¸‹æ‰¾ä¸åˆ°æ­£ç¢ºçš„ next      â”‚ ðŸŸ¡ ä¸­  â”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  ---
  ðŸ”§ ä¿®å¾©å»ºè­°ï¼ˆä¸æ”¹ codeï¼Œåƒ…åˆ†æžï¼‰

  ä¿®å¾©æ–¹æ¡ˆ 1ï¼šçµ±ä¸€ä½¿ç”¨ draggingCardId

  // dragOver æ™‚
  const list = draggingCardId ? items.filter((x)=>x.id!==draggingCardId) : items;
  ghostBeforeRef.current = gi >= list.length ? '__END__' : list[gi].id;

  // drop æ™‚ä¹Ÿç”¨åŒæ¨£çš„é‚è¼¯
  const list = draggingCardId ? items.filter((x) => x.id !== draggingCardId) : items;
  beforeId = idx >= list.length ? '__END__' : list[idx].id;

  ä¿®å¾©æ–¹æ¡ˆ 2ï¼šåŽŸå­åŒ– moveCardToGroup æ“ä½œ

  // åœ¨ storageService ä¸­å¯¦ç¾
  moveCardToGroup(cardId, targetCategoryId, targetSubcategoryId, beforeId) {
    // 1. ç²å–ç›®æ¨™ group çš„æ‰€æœ‰å¡ç‰‡
    const targetCards = await getCardsInSubcategory(targetSubcategoryId);

    // 2. æ‰¾åˆ° beforeId çš„ä½ç½®
    const insertIndex = targetCards.findIndex(c => c.id === beforeId);

    // 3. è¨ˆç®—æ–°çš„ order å€¼
    const newOrder = calculateOrderBetween(targetCards[insertIndex-1], targetCards[insertIndex]);

    // 4. ä¸€æ¬¡æ€§æ›´æ–° category + subcategory + order
    await updateCard(cardId, {
      category: targetCategoryId,
      subcategoryId: targetSubcategoryId,
      order: newOrder
    });
  }

  ä¿®å¾©æ–¹æ¡ˆ 3ï¼šç§»é™¤ DOM æŸ¥è©¢ Fallback

  // ç›´æŽ¥ä½¿ç”¨ ghostBeforeRefï¼Œä¸è¦ä¾è³´ DOM æŸ¥è©¢
  const beforeId = ghostBeforeRef.current;
  if (!beforeId) {
    // fallback åˆ° ghostIndex
    let idx = ghostIndex;
    if (idx == null) idx = computeGhostIndex(e.clientX, e.clientY, e.target);
    const list = draggingCardId ? items.filter(...) : items;
    beforeId = idx >= list.length ? '__END__' : list[idx].id;
  }
